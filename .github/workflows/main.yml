name: Spring boot docker image CI/CD

on:
  push:
    branches: [ main ]

env:
  DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
  DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
  
jobs:
  build:
#    runs-on: ubuntu-latest
    name: Build and Push Docker Image
    #  레이블이 여러개인 경우 모두 만족하는 호스트에서 실행 
    runs-on: 
      - self-hosted 
      - Linux
      - X64
      - kosa-server

    steps:
    - name: kosa 서버에 파일 복사
      run: echo "kosa 빌드 스크립트 작성 예정" > output.txt

    # 소스 복사 
    #- name: 소스 복사 
    #  run: git clone https://github.com/masungil70/kosa-devops-step2
    #- uses: actions/checkout@v3
    #- name: 폴더 정리  
    #  run: rm -rf kosa-devops-step2
  #
    #- name: 소스 복사 
    #  run: git clone https://github.com/masungil70/kosa-devops-step2
  #
    ##- name: Setup JDK17 
    ##  uses: actions/setup-java@v3
    ##  with:
    ##    java-version: '17'
    ##    distribution: 'temurin'
    #
    #- name: gradlew 파일 실행 권한 설정 
    #  run: |
    #    cd kosa-devops-step2
    #    chmod +x gradlew
    #    
    #- name: Test with gradle
    #  run: |
    #    cd kosa-devops-step2
    #    ./gradlew --info test
    # 
    #- name: Spring boot  실행 파일 생성 '
    #  run: |
    #    cd kosa-devops-step2
    #    ./gradlew bootJar 
    #    
    #- name: docker image 생성 
    #  run: |
    #    cd kosa-devops-step2
    #    docker build -t ${{env.DOCKER_USERNAME}}/devops_step2:latest .
#
    #- name: docker login
    #  uses: docker/login-action@v1
    #  with:
    #    username: ${{env.DOCKER_USERNAME}}
    #    password: ${{secrets.DOCKER_PASSWORD}}
    #    
    #- name: docker image 허브에 저장 
    #  run: docker push ${{env.DOCKER_USERNAME}}/devops_step2:latest
    
    #- name: 파일 업로드 
    #  uses: actions/upload-artifact@v4
    #  with:
    #    name: my-artifact
    #    path: |
    #      kosa-devops-step2/docker-compose_nginx.yml
    #      kosa-devops-step2/nginx/nginx.conf

  deploy:
    needs: build
    name: Deploy
    #  레이블이 여러개인 경우 모두 만족하는 호스트에서 실행 
    runs-on: 
      - self-hosted
      - Linux
      - X64
      - team1-server

    steps:
    - name: TEAM1 서버에 파일 복사
      run: echo "배포 스크립트 작성 예정" > output.txt

      # copy yml file from src
    #- uses: actions/checkout@v3
    #  with:
    #    sparse-checkout: |
    #      docker-compose_nginx.yml
    #      nginx/nginx.conf
    #    sparse-checkout-cone-mode: false
    #    clean: true

    #- name: 파일 다운로드
    #  uses: actions/download-artifact@v4
    #  with:
    #    name: my-artifact

    #- name: docker login
    #  uses: docker/login-action@v1
    #  with:
    #    username: ${{env.DOCKER_USERNAME}}
    #    password: ${{secrets.DOCKER_PASSWORD}}

    #- name: docker image pull
    #  run: docker pull ${{env.DOCKER_USERNAME}}/devops_step2:latest

    #- name: docker compose 실행
    #  run: docker compose -f docker-compose_nginx.yml up -d 

    #- name: 운영서버로 파일 복사 및 실행 
    #  run: |
    #    cd kosa-devops-step2
    #    scp ./docker-compose_nginx.yml aws-master:~
    #    scp ./nginx/nginx.conf      aws-master:~/nginx/nginx.conf
    #    ssh aws-master ./run.sh > /dev/null

    